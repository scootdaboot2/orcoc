var igpoint6=new ol.source.Cluster({distance:2,source:new ol.source.Vector({format:new ol.format.EsriJSON(),url:'https://egp.nwcg.gov/arcgis/rest/services/FireCOP/FireDetections/MapServer/4/query?f=json'+'&where=AgeInHours < 6&returnGeometry=true&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100'+'&token='+egp})});var igpoint12=new ol.source.Cluster({distance:2,source:new ol.source.Vector({format:new ol.format.EsriJSON(),url:'https://egp.nwcg.gov/arcgis/rest/services/FireCOP/FireDetections/MapServer/4/query?f=json'+'&where=AgeInHours < 12&returnGeometry=true&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100'+'&token='+egp})});var igpoint24=new ol.source.Cluster({distance:2,source:new ol.source.Vector({format:new ol.format.EsriJSON(),url:'https://egp.nwcg.gov/arcgis/rest/services/FireCOP/FireDetections/MapServer/4/query?f=json'+'&where=AgeInHours < 24&returnGeometry=true&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100'+'&token='+egp})});var igpoint48=new ol.source.Cluster({distance:2,source:new ol.source.Vector({format:new ol.format.EsriJSON(),url:'https://egp.nwcg.gov/arcgis/rest/services/FireCOP/FireDetections/MapServer/4/query?f=json'+'&where=AgeInHours < 48&returnGeometry=true&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100'+'&token='+egp})});var viirs6=new ol.source.Cluster({distance:2,source:new ol.source.Vector({format:new ol.format.EsriJSON(),url:'https://egp.nwcg.gov/arcgis/rest/services/FireCOP/FireDetections/MapServer/2/query?f=json'+'&where=AgeInHours < 6&returnGeometry=true&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100'+'&token='+egp})});var viirs12=new ol.source.Cluster({distance:2,source:new ol.source.Vector({format:new ol.format.EsriJSON(),url:'https://egp.nwcg.gov/arcgis/rest/services/FireCOP/FireDetections/MapServer/2/query?f=json'+'&where=AgeInHours < 12&returnGeometry=true&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100'+'&token='+egp})});var viirs24=new ol.source.Cluster({distance:2,source:new ol.source.Vector({format:new ol.format.EsriJSON(),url:'https://egp.nwcg.gov/arcgis/rest/services/FireCOP/FireDetections/MapServer/2/query?f=json'+'&where=AgeInHours < 24&returnGeometry=true&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100'+'&token='+egp})});var viirs48=new ol.source.Cluster({distance:2,source:new ol.source.Vector({format:new ol.format.EsriJSON(),url:'https://egp.nwcg.gov/arcgis/rest/services/FireCOP/FireDetections/MapServer/2/query?f=json'+'&where=AgeInHours < 48&returnGeometry=true&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100'+'&token='+egp})});var nfs=newFiresLayer.getSource();var ofs=ongoingFiresLayer.getSource();var rxfs=rxFiresLayer.getSource();var countFeatures=function(layerSource,k){layerSource.once('change',function(e){if(layerSource.getState()==='ready'){legend[k].innerHTML=layerSource.getFeatures().length+' '+legend[k].innerHTML;}});}
function firepop(ids,layerSource){layerSource.once('change',function(e){if(layerSource.getState()==='ready'){for(i=0;i<layerSource.getFeatures().length;i++){var key=layerSource.getFeatures()[i].getProperties().UniqueFireIdentifier;var value={};ids[key]=value;}}});}firepop(nfids,nfs);firepop(ofids,ofs);firepop(rxfids,rxfs);function extend(obj,src){for(var key in src){if(src.hasOwnProperty(key))obj[key]=src[key];}return obj;}var inc=extend(nfids,ofids);incidents=extend(inc,rxfids);countFeatures(nfs,0);countFeatures(ofs,1);countFeatures(rxfs,2);var egpModisFireDetectionCentroidLayer6=new ol.layer.Vector({title:'MODIS < 6 Hour',source:new ol.source.Cluster({distance:2,source:new ol.source.Vector({format:new ol.format.EsriJSON(),url:'https://egp.nwcg.gov/arcgis/rest/services/FireCOP/FireDetections/MapServer/0/query?f=json'+'&where=AgeInHours < 6&returnGeometry=true&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100'+'&token='+egp})}),extent:[-13385849.855545742,4164163.9360093023,-12120670.513975333,5733155.322681262],style:egpModisStyles['6']});var egpModisFireDetectionCentroidLayer12=new ol.layer.Vector({title:'MODIS < 12 Hour',source:new ol.source.Cluster({distance:2,source:new ol.source.Vector({format:new ol.format.EsriJSON(),url:'https://egp.nwcg.gov/arcgis/rest/services/FireCOP/FireDetections/MapServer/0/query?f=json'+'&where=AgeInHours < 12&returnGeometry=true&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100'+'&token='+egp})}),extent:[-13385849.855545742,4164163.9360093023,-12120670.513975333,5733155.322681262],style:egpModisStyles['12']});var egpModisFireDetectionCentroidLayer24=new ol.layer.Vector({title:'MODIS < 24 Hour',source:new ol.source.Cluster({distance:2,source:new ol.source.Vector({format:new ol.format.EsriJSON(),url:'https://egp.nwcg.gov/arcgis/rest/services/FireCOP/FireDetections/MapServer/0/query?f=json'+'&where=AgeInHours < 24&returnGeometry=true&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100'+'&token='+egp})}),extent:[-13385849.855545742,4164163.9360093023,-12120670.513975333,5733155.322681262],style:egpModisStyles['24'],opacity:0.6,brightness:0.2});var egpModisFireDetectionCentroidLayer48=new ol.layer.Vector({title:'MODIS < 48 Hour',source:new ol.source.Cluster({distance:2,source:new ol.source.Vector({format:new ol.format.EsriJSON(),url:'https://egp.nwcg.gov/arcgis/rest/services/FireCOP/FireDetections/MapServer/0/query?f=json'+'&where=AgeInHours < 48&returnGeometry=true&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100'+'&token='+egp})}),extent:[-13385849.855545742,4164163.9360093023,-12120670.513975333,5733155.322681262],style:egpModisStyles['48'],opacity:0.6,brightness:0.2});var egpModisFireDetectionCentroidLayer999=new ol.layer.Vector({source:new ol.source.Cluster({distance:2,source:new ol.source.Vector({format:new ol.format.EsriJSON(),url:'https://egp.nwcg.gov/arcgis/rest/services/FireCOP/FireDetections/MapServer/0/query?f=json'+'&where=AgeInHours < 50&returnGeometry=true&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100'+'&token='+egp})}),extent:[-13385849.855545742,4164163.9360093023,-12120670.513975333,5733155.322681262],style:egpModisStyles['999'],opacity:0.6,brightness:0.2,visible:false});viirsCentroidLayer6.setSource(viirs6);viirsCentroidLayer12.setSource(viirs12);viirsCentroidLayer24.setSource(viirs24);viirsCentroidLayer48.setSource(viirs48);igpointCentroidLayer6.setSource(igpoint6);igpointCentroidLayer12.setSource(igpoint12);igpointCentroidLayer24.setSource(igpoint24);igpointCentroidLayer48.setSource(igpoint48);function _doToggle(){ol3d.setEnabled(!ol3d.getEnabled());}function init3D(){ol3d=new olcs.OLCesium({map:map,});var scene=ol3d.getCesiumScene();var terrainProvider=new Cesium.CesiumTerrainProvider({url:'//assets.agi.com/stk-terrain/world',equestWaterMask:false,requestVertexNormals:true});scene.terrainProvider=terrainProvider;scene.globe.enableLighting=true;var camera=ol3d.getCamera();camera.setTilt(Math.PI*(93.16/180));camera.setPosition(ol.proj.transform([-119.461349,39.755695],'EPSG:4326','EPSG:3857'));camera.setAltitude(5553.276);camera.setHeading(Math.PI*((360-238.789703)/180));camera.setDistance(0);}function toggle3D(){if(!ol3d){if(camBox!==undefined){nvcams.setTarget();maps.removeChild(camBox);camBox=undefined;}var s=window.lazyLoadCesium();s.onload=function(){init3D();_doToggle();};}else{_doToggle();}}var camBox;var threeD=document.createElement('div');threeD.className='cesiumToggle ol-unselectable ol-control';threeD.appendChild(toggle);var change3d=new ol.control.Control({element:threeD});toggle.addEventListener('click',function(){if(map3d.className=='dontsee'){map.removeLayer(sagegrouse);map.removeLayer(nvBlmCamsLayer);swipe.style.display='none';slide.style.display='none';toggle3D();map3d.className='see';toggle.innerHTML='2D VIEW';}else{toggle3D();map3d.className='dontsee';toggle.innerHTML='3D VIEW';map.getLayers().setAt(8,sagegrouse);map.getLayers().setAt(17,nvBlmCamsLayer);map.setView(new ol.View({center:[-12753260.184760537,4948659.629345282],zoom:5.55,extent:[-13385849.855545742,4164163.9360093023,-12120670.513975333,5733155.322681262]}));swipe.style.display='';slide.style.display='';}});var overlay=new ol.Overlay({element:container,id:'dataOverlay',autoPan:true,autoPanAnimation:{duration:250}});closer.onclick=function(){overlay.setPosition(undefined);closer.blur();return false;}
var button=document.getElementById('button');var overlayControl=function(e){var vv=map.getView();vv.on('change:resolution',function(e){vv.getResolution()<750?resources.style.display='block':resources.style.display='none';});map.getOverlayById('dataOverlay')?(map.removeOverlay(overlay),element.removeChild(resources)):(map.addOverlay(overlay),element.appendChild(resources));};button.addEventListener('click',overlayControl,false);var element=document.createElement('div');element.className='display-overlay ol-control';element.appendChild(button);var displayOverlayControl=new ol.control.Control({element:element});rCloser.onclick=function(){resources.style.display='none';rCloser.blur();return false;}
var bigScreen=new ol.control.FullScreen({source:'fullscreen'});var controls=[new ol.control.Attribution(),new ol.control.MousePosition({undefinedHTML:'outside',projection:'EPSG:4326',coordinateFormat:ol.coordinate.toStringHDMS}),new ol.control.Rotate({autohide:false}),new ol.control.ScaleLine({}),new ol.control.Zoom(),new ol.control.ZoomSlider(),bigScreen,displayOverlayControl,change3d];var layers=[new ol.layer.Tile({source:new ol.source.OSM({attributions:["Map tiles by Carto, under CC BY 3.0.",ol.source.OSM.ATTRIBUTION],url:'https://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png'}),title:"Open Street Map",type:'base',wrapX:false,visible:false}),mapboxDark,mapbox,raster,bing,openTopo,stamen,usgsTopo,sagegrouse,doe,dod,fws,nps,bia,fs,blm,vectorLayer,prepoLayer,fovOverlay,nvBlmCamsLayer,igpointCentroidLayer48,igpointCentroidLayer24,igpointCentroidLayer12,igpointCentroidLayer6,viirsCentroidLayer48,viirsCentroidLayer24,viirsCentroidLayer12,viirsCentroidLayer6,egpModisFireDetectionCentroidLayer48,egpModisFireDetectionCentroidLayer24,egpModisFireDetectionCentroidLayer12,egpModisFireDetectionCentroidLayer6,geomacPerimsLayer,rxFiresLayer,ongoingFiresLayer,newFiresLayer,teamFiresLayer,trackLayer,]
var overallView=new ol.View({center:[-12753260.184760537,4948659.629345282],zoom:5.55,});var map=new ol.Map({layers:layers,controls:controls,target:'map2d',view:overallView,logo:({href:'https://gacc.nifc.gov/gbcc/',src:'firecesium/examples/data/GBCC_1b.png'})});sagegrouse.on('precompose',function(e){var ctx=e.context;var width=ctx.canvas.width*(swipe.value/100);ctx.save();ctx.beginPath();ctx.rect(width,0,ctx.canvas.width,ctx.canvas.height);ctx.clip();});sagegrouse.on('postcompose',function(e){var ctx=e.context;ctx.restore();});swipe.addEventListener('input',function(){map.render();},false);geomacPerimsLayer.set('altitudeMode','clampToGround');fovOverlay.set('altitudeMode','clampToGround');vectorLayer.set('selectable',true);vectorLayer.set('id','dispatches');ongoingFiresLayer.set('selectable',true);ongoingFiresLayer.set('id','ongoing');rxFiresLayer.set('selectable',true);rxFiresLayer.set('id','rx');newFiresLayer.set('selectable',true);newFiresLayer.set('id','new');teamFiresLayer.set('id','team');nvBlmCamsLayer.set('selectable',true);nvBlmCamsLayer.set('id','nvcams');teamFiresLayer.set('selectable',true);geomacPerimsLayer.set('id','geomac');geomacPerimsLayer.set('selectable',true);prepoLayer.set('id','prepo');prepoLayer.set('selectable',true);ongoingFiresLayer.set('overlay',true);rxFiresLayer.set('overlay',true);newFiresLayer.set('overlay',true);teamFiresLayer.set('overlay',true);geomacPerimsLayer.set('overlay',true);prepoLayer.set('overlay',true);ol.Feature.prototype.getLayer=function(){var this_=this,layer_;var sameFeature=function(feature){return(this_===feature)?true:false;};map.getLayers().forEach(function(layer){var source=layer.getSource();if(source instanceof ol.source.Vector){var features=source.getFeatures();if(features.length>0){var found=features.some(sameFeature);if(found){layer_=layer;}}}});return layer_;};function isTouchDevice(){return'ontouchstart'in document.documentElement;}if(isTouchDevice()){console.log('is touch');var selectTap=new ol.interaction.Select({condition:ol.events.condition.click,layers:[ongoingFiresLayer,rxFiresLayer,newFiresLayer,teamFiresLayer,geomacPerimsLayer,prepoLayer,nvBlmCamsLayer],style:function(feature){if(feature.getLayer().get('id')=='rx'){var acres=feature.get('DailyAcres')?feature.get('DailyAcres'):feature.get('DiscoveryAcres');var style=new ol.style.Style({image:new ol.style.Circle({stroke:new ol.style.Stroke({color:'fuchsia',width:3}),radius:(acres<=18.5)?3+3.5:3+1.2*Math.log(acres)})});}if(feature.getLayer().get('id')=='new'){var acres=feature.get('DailyAcres')?feature.get('DailyAcres'):feature.get('DiscoveryAcres');var style=new ol.style.Style({image:new ol.style.Circle({stroke:new ol.style.Stroke({color:'rgba(232,14,14,1)',width:3}),radius:(acres<=18.5)?3+3.5:3+1.2*Math.log(acres)})});}if(feature.getLayer().get('id')=='ongoing'){var acres=feature.get('DailyAcres')?feature.get('DailyAcres'):feature.get('DiscoveryAcres');var style=new ol.style.Style({image:new ol.style.Circle({stroke:new ol.style.Stroke({color:'rgba(254,253,6,1)',width:4}),radius:(acres<=18.5)?3+3.5:3+1.2*Math.log(acres)})});}if(feature.getLayer().get('id')=='team'){var acres=feature.get('DailyAcres')?feature.get('DailyAcres'):feature.get('DiscoveryAcres');var style=new ol.style.Style({image:new ol.style.Circle({stroke:new ol.style.Stroke({color:'rgba(145,9,198,1)',width:4}),radius:(acres<=18.5)?3+3.5:3+1.2*Math.log(acres)})});}if(feature.getLayer().get('id')=='geomac'){var acres=feature.get('gisacres')?feature.get('gisacres'):'';var style=new ol.style.Style({stroke:new ol.style.Stroke({color:'rgba(1,255,67,1)',width:2}),fill:new ol.style.Fill({color:'rgba(232,14,14,.2)'})});}if(feature.getLayer().get('id')=='prepo'){var style=new ol.style.Style({image:new ol.style.RegularShape({fill:new ol.style.Fill({color:'#cfdb41'}),stroke:new ol.style.Stroke({color:'#222',width:1.5}),points:5,radius:7,radius2:4,angle:0})})}if(feature.getLayer().get('id')=='nvcams'){var style=new ol.style.Style({image:new ol.style.Icon(({opacity:.75,scale:.4,src:'https://earth.google.com/images/kml-icons/track-directional/track-0.png',rotation:Math.PI*parseFloat(feature.getProperties()['az_current'])/180,rotateWithView:true}))})}return style;}});map.addInteraction(selectTap);selectTap.on('select',function(e){var coordinate;var feature=e.selected[0];if(feature){var feature=e.selected[0];var fid=feature.get('gisacres')?feature.get('incidentname').toUpperCase():((feature.get('attribution'))?feature.get('id'):feature.get('IncidentName').toUpperCase());function displayInfo(){coordinate=ol.proj.transform([feature.get('POOLongitude')?feature.get('POOLongitude'):feature.get('InitialLongitude'),feature.get('POOLatitude')?feature.get('POOLatitude'):feature.get('InitialLatitude')],'EPSG:4326','EPSG:3857');var sagegrouseFeatures=sagegrouse?sagegrouse.getSource().getFeaturesAtCoordinate(ol.proj.transform([feature.get('POOLongitude')?feature.get('POOLongitude'):feature.get('InitialLongitude'),feature.get('POOLatitude')?feature.get('POOLatitude'):feature.get('InitialLatitude')],'EPSG:4326','EPSG:3857')):[];uniqueFireIdentifier.innerHTML=feature.get('UniqueFireIdentifier')?feature.get('UniqueFireIdentifier'):'unknown';incidentName.innerHTML=feature.get('IncidentName')?feature.get('IncidentName'):'unknown';fireDiscoveryDateTime.innerHTML=feature.get('FireDiscoveryDateTime')?new Date(parseInt(feature.get('FireDiscoveryDateTime'))).toLocaleString():'unknown';dailyAcres.innerHTML=feature.get('DailyAcres')?(feature.get('DailyAcres')+'  [total]'):feature.get('DiscoveryAcres')?feature.get('DiscoveryAcres')+'  [discovery]':'unknown';strategy.innerHTML=feature.get('InitialFireStrategy')?feature.get('InitialFireStrategy'):'Full Suppression';fireCause.innerHTML=feature.get('FireCause')?feature.get('FireCause'):'unknown';fuelType.innerHTML=feature.get('PrimaryFuelModel')?feature.get('PrimaryFuelModel'):'unknown';incidentCommanderName.innerHTML=feature.get('IncidentCommanderName')?feature.get('IncidentCommanderName'):'unknown';ownership.innerHTML=feature.get('POOLandownerCategory')?feature.get('POOLandownerCategory'):feature.get('POOProtectingAgency');dispatchCenterID.innerHTML=feature.get('DispatchCenterID')?feature.get('DispatchCenterID'):'unknown';predictiveServiceAreaID.innerHTML=feature.get('PredictiveServiceAreaID')?feature.get('PredictiveServiceAreaID'):'unknown';latLong.innerHTML=(feature.get('POOLatitude')&&feature.get('POOLongitude'))?feature.get('POOLatitude')+' , '+feature.get('POOLongitude'):feature.get('InitialLatitude')+' , '+feature.get('InitialLongitude');sagegrouseOrigin.innerHTML=(sagegrouseFeatures.length>0)?sagegrouseFeatures[0].get('Species')+': '+sagegrouseFeatures[0].get('Habitat'):'No.';}function displayResources(items){function popRes(arr,target,resk,resIds){target.innerHTML='';var count=0;var loadHTML=arr.map(function(current_item,index,initial_array){fid==Object.keys(current_item)?(count=count+1,target.innerHTML+=current_item[Object.keys(current_item)]['Name']+current_item[Object.keys(current_item)]['Mob Date']+current_item[Object.keys(current_item)]['Agency']):'';});resk.innerHTML=count+resIds;return loadHTML;}return items.map(function(current_item,index,initial_array){Resources[index].innerHTML='';Object.keys(current_item).length===0&&current_item.constructor===Object?(Resources[index].innerHTML=0+resIds[index]):popRes(current_item,ResourcesP[index],Resources[index],resIds[index]);});}var displayFov=function(feature){var clone=feature.clone();if(clone!==fovStyle){if(fovStyle){fovOverlay.getSource().removeFeature(fovStyle);}if(clone){var id=clone.get('id');clone.setGeometry(polyKeys[clone.get('id')]);fovOverlay.getSource().addFeature(clone);}fovStyle=clone;}};if(feature.get('UniqueFireIdentifier')){displayInfo();var justDate=feature.get('FireDiscoveryDateTime')?(new Date(parseInt(feature.get('FireDiscoveryDateTime'))).getMonth()+1)+'/'+new Date(parseInt(feature.get('FireDiscoveryDateTime'))).getDate()+'/'+new Date(parseInt(feature.get('FireDiscoveryDateTime'))).getFullYear():'unknown';content.innerHTML=incidentName.innerHTML+'<br>'+dailyAcres.innerHTML+'<br>'+justDate;map.getOverlayById('dataOverlay')?overlay.setPosition(feature.getGeometry().getCoordinates()):'';displayResources(resItems);}if(feature.getProperties()["type"]){content.innerHTML=feature.get('name');map.getOverlayById('dataOverlay')?overlay.setPosition(feature.getGeometry().getCoordinates()):'';displayResources(resItems);}if(feature.get('gisacres')){justDate=feature.get('perimeterdatetime')?(new Date(parseInt(feature.get('perimeterdatetime'))).getMonth()+1)+'/'+new Date(parseInt(feature.get('perimeterdatetime'))).getDate()+'/'+new Date(parseInt(feature.get('perimeterdatetime'))).getFullYear():'unknown';content.innerHTML=feature.get('incidentname')+'<br>'+feature.get('gisacres')+'<br>'+justDate;map.getOverlayById('dataOverlay')?overlay.setPosition(new ol.extent.getCenter(feature.getGeometry().getExtent())):'';}if(feature.get('attribution')){displayFov(feature);}}});}else{console.log('no touch');var selectHover=new ol.interaction.Select({condition:ol.events.condition.pointerMove,layers:[ongoingFiresLayer,rxFiresLayer,newFiresLayer,teamFiresLayer,geomacPerimsLayer,prepoLayer,nvBlmCamsLayer],style:function(feature){if(feature.getLayer().get('id')=='rx'){var acres=feature.get('DailyAcres')?feature.get('DailyAcres'):feature.get('DiscoveryAcres');var x=(acres<=18.5)?3+3.5:3+1.2*Math.log(acres);var style=new ol.style.Style({image:new ol.style.Circle({stroke:new ol.style.Stroke({color:'fuchsia',width:3}),radius:(acres<=18.5)?3+3.5:3+1.2*Math.log(acres)})});}if(feature.getLayer().get('id')=='new'){var acres=feature.get('DailyAcres')?feature.get('DailyAcres'):feature.get('DiscoveryAcres');var style=new ol.style.Style({image:new ol.style.Circle({stroke:new ol.style.Stroke({color:'rgba(232,14,14,1)',width:3}),radius:(acres<=18.5)?3+3.5:3+1.2*Math.log(acres)})});}if(feature.getLayer().get('id')=='ongoing'){var acres=feature.get('DailyAcres')?feature.get('DailyAcres'):feature.get('DiscoveryAcres');var style=new ol.style.Style({image:new ol.style.Circle({stroke:new ol.style.Stroke({color:'rgba(254,253,6,1)',width:4}),radius:(acres<=18.5)?3+3.5:3+1.2*Math.log(acres)})});}if(feature.getLayer().get('id')=='team'){var acres=feature.get('DailyAcres')?feature.get('DailyAcres'):feature.get('DiscoveryAcres');var style=new ol.style.Style({image:new ol.style.Circle({stroke:new ol.style.Stroke({color:'rgba(145,9,198,1)',width:4}),radius:(acres<=18.5)?3+3.5:3+1.2*Math.log(acres)})});}if(feature.getLayer().get('id')=='geomac'){var acres=feature.get('gisacres')?feature.get('gisacres'):'';var style=new ol.style.Style({stroke:new ol.style.Stroke({color:'rgba(1,255,67,1)',width:2}),fill:new ol.style.Fill({color:'rgba(232,14,14,.2)'})});}if(feature.getLayer().get('id')=='prepo'){var style=new ol.style.Style({image:new ol.style.RegularShape({fill:new ol.style.Fill({color:'rgba(235, 255, 0, 1)'}),stroke:new ol.style.Stroke({color:'#222',width:1.5}),points:5,radius:8,radius2:5,angle:0})})}if(feature.getLayer().get('id')=='nvcams'){var style=new ol.style.Style({image:new ol.style.Icon(({opacity:.75,scale:.4,src:'https://earth.google.com/images/kml-icons/track-directional/track-0.png',rotation:Math.PI*parseFloat(feature.getProperties()['az_current'])/180,rotateWithView:true}))})}return style;}});map.addInteraction(selectHover);selectHover.on('select',function(e){var coordinate;var feature=e.selected[0];if(feature){var feature=e.selected[0];var fid=(feature.getProperties()["type"])?feature.get('name'):(feature.get('gisacres')?feature.get('incidentname').toUpperCase():((feature.get('attribution'))?feature.get('id'):feature.get('IncidentName').toUpperCase()));function displayInfo(){coordinate=ol.proj.transform([feature.get('POOLongitude')?feature.get('POOLongitude'):feature.get('InitialLongitude'),feature.get('POOLatitude')?feature.get('POOLatitude'):feature.get('InitialLatitude')],'EPSG:4326','EPSG:3857');var sagegrouseFeatures=sagegrouse?sagegrouse.getSource().getFeaturesAtCoordinate(ol.proj.transform([feature.get('POOLongitude')?feature.get('POOLongitude'):feature.get('InitialLongitude'),feature.get('POOLatitude')?feature.get('POOLatitude'):feature.get('InitialLatitude')],'EPSG:4326','EPSG:3857')):[];uniqueFireIdentifier.innerHTML=feature.get('UniqueFireIdentifier')?feature.get('UniqueFireIdentifier'):'unknown';incidentName.innerHTML=feature.get('IncidentName')?feature.get('IncidentName'):'unknown';fireDiscoveryDateTime.innerHTML=feature.get('FireDiscoveryDateTime')?new Date(parseInt(feature.get('FireDiscoveryDateTime'))).toLocaleString():'unknown';dailyAcres.innerHTML=feature.get('DailyAcres')?(feature.get('DailyAcres')+'  [total]'):feature.get('DiscoveryAcres')?feature.get('DiscoveryAcres')+'  [discovery]':'unknown';strategy.innerHTML=feature.get('InitialFireStrategy')?feature.get('InitialFireStrategy'):'Full Suppression';fireCause.innerHTML=feature.get('FireCause')?feature.get('FireCause'):'unknown';fuelType.innerHTML=feature.get('PrimaryFuelModel')?feature.get('PrimaryFuelModel'):'unknown';incidentCommanderName.innerHTML=feature.get('IncidentCommanderName')?feature.get('IncidentCommanderName'):'unknown';ownership.innerHTML=feature.get('POOLandownerCategory')?feature.get('POOLandownerCategory'):feature.get('POOProtectingAgency');dispatchCenterID.innerHTML=feature.get('DispatchCenterID')?feature.get('DispatchCenterID'):'unknown';predictiveServiceAreaID.innerHTML=feature.get('PredictiveServiceAreaID')?feature.get('PredictiveServiceAreaID'):'unknown';latLong.innerHTML=(feature.get('POOLatitude')&&feature.get('POOLongitude'))?feature.get('POOLatitude')+' , '+feature.get('POOLongitude'):feature.get('InitialLatitude')+' , '+feature.get('InitialLongitude');sagegrouseOrigin.innerHTML=(sagegrouseFeatures.length>0)?sagegrouseFeatures[0].get('Species')+': '+sagegrouseFeatures[0].get('Habitat'):'No.';}function displayResources(items){function popRes(arr,target,resk,resIds){target.innerHTML='';var count=0;var loadHTML=arr.map(function(current_item,index,initial_array){fid==Object.keys(current_item)?(count=count+1,target.innerHTML+=current_item[Object.keys(current_item)]['Name']+current_item[Object.keys(current_item)]['Mob Date']+current_item[Object.keys(current_item)]['Agency']):'';});resk.innerHTML=count+resIds;return loadHTML;}return items.map(function(current_item,index,initial_array){Resources[index].innerHTML='';Object.keys(current_item).length===0&&current_item.constructor===Object?(Resources[index].innerHTML=0+resIds[index]):popRes(current_item,ResourcesP[index],Resources[index],resIds[index]);});}var displayFov=function(feature){var clone=feature.clone();if(clone!==fovStyle){if(fovStyle){fovOverlay.getSource().removeFeature(fovStyle);}if(clone){var id=clone.get('id');clone.setGeometry(polyKeys[clone.get('id')]);fovOverlay.getSource().addFeature(clone);}fovStyle=clone;}};if(feature.get('UniqueFireIdentifier')){displayInfo();var justDate=feature.get('FireDiscoveryDateTime')?(new Date(parseInt(feature.get('FireDiscoveryDateTime'))).getMonth()+1)+'/'+new Date(parseInt(feature.get('FireDiscoveryDateTime'))).getDate()+'/'+new Date(parseInt(feature.get('FireDiscoveryDateTime'))).getFullYear():'unknown';content.innerHTML=incidentName.innerHTML+'<br>'+dailyAcres.innerHTML+'<br>'+justDate;map.getOverlayById('dataOverlay')?overlay.setPosition(feature.getGeometry().getCoordinates()):'';displayResources(resItems);}if(feature.getProperties()["type"]){content.innerHTML=feature.get('name');map.getOverlayById('dataOverlay')?overlay.setPosition(feature.getGeometry().getCoordinates()):'';displayResources(resItems);}if(feature.get('gisacres')){justDate=feature.get('perimeterdatetime')?(new Date(parseInt(feature.get('perimeterdatetime'))).getMonth()+1)+'/'+new Date(parseInt(feature.get('perimeterdatetime'))).getDate()+'/'+new Date(parseInt(feature.get('perimeterdatetime'))).getFullYear():'unknown';content.innerHTML=feature.get('incidentname')+'<br>'+feature.get('gisacres')+'<br>'+justDate;map.getOverlayById('dataOverlay')?overlay.setPosition(new ol.extent.getCenter(feature.getGeometry().getExtent())):'';displayResources(resItems);}if(feature.get('attribution')){displayFov(feature);}}});var selectClick=new ol.interaction.Select({condition:ol.events.condition.click,layers:[geomacPerimsLayer,mapboxDark,mapbox,raster,bing,openTopo,stamen,usgsTopo,vectorLayer,nvBlmCamsLayer,],style:function(feature){if(feature.getLayer().get('id')=='nvcams'){var style=new ol.style.Style({image:new ol.style.Icon(({opacity:.75,scale:.4,src:'https://earth.google.com/images/kml-icons/track-directional/track-0.png',rotation:Math.PI*parseFloat(feature.getProperties()['az_current'])/180,rotateWithView:true}))})}else
var style=new ol.style.Style({fill:new ol.style.Fill({color:'rgba(255, 145, 20, .1)'}),stroke:new ol.style.Stroke({color:'rgba(0,0,255, .8)',width:3})})
return style;}});map.addInteraction(selectClick);selectClick.on('select',function(e){var feature=e.selected[0];if(feature){if(feature.get('id')){if(camBox!==undefined){nvcams.setTarget();maps.removeChild(camBox);camBox=undefined;}var contextMenu=new ContextMenu({width:170,default_items:true,items:[{text:'Close Camera View',callback:hide},{text:'15min Time Lapse',callback:function(){startMjpgTimeLapse(.25)}},{text:'1hr Time Lapse',callback:function(){startMjpgTimeLapse(1)}},{text:'6hr Time Lapse',callback:function(){startMjpgTimeLapse(6)}},{text:'12hr Time Lapse',callback:function(){startMjpgTimeLapse(12)}},{text:'Resume Feed',callback:stopTimeLapse}]});var stamp=(new Date).getTime();var feature=e.selected[0];map.getView().setRotation(2*Math.PI-(Math.PI*parseFloat(feature.getProperties()['az_current'])/180));currentCam=feature;var imgUrl="http://myers.seismo.unr.edu:8095/vulcan/v0/camera/"+feature.getProperties()['id']+"/image?lastmodified="+stamp;var imageSource=new ol.source.ImageStatic({attributions:'© <a href="http://alerttahoe.seismo.unr.edu/firecams.html">ALERT(Tahoe)</a>',url:imgUrl,projection:viewProjection,imageExtent:viewExtent});imageMap.setSource(imageSource);imageMap.on('postcompose',function(){nvcams.render();});camBox=document.createElement('div');camBox.setAttribute('id','webcam');maps.appendChild(camBox);nvcams.setTarget('webcam');nvcams.getControls().extend([contextMenu]);camBox.style.zIndex=1;selectClick.getFeatures().clear();}else{if(camBox!==undefined){nvcams.setTarget();maps.removeChild(camBox);camBox=undefined;}var polygon=(feature.getGeometry());var size=(map.getSize());var aa=polygon.getExtent();var oo=ol.extent.getCenter(aa);var start=+new Date();var pan=ol.animation.pan({duration:800,source:(map.getView().getCenter()),start:start});var bounce=ol.animation.bounce({duration:800,resolution:1.2*map.getView().getResolution(),start:start});map.beforeRender(pan,bounce);map.getView().fit(polygon,size,{padding:[5,5,5,5],constrainResolution:false});}}else{if(camBox!==undefined){nvcams.setTarget();maps.removeChild(camBox);camBox=undefined;map.getVew().setRotation(0);}map.beforeRender(ol.animation.pan({duration:800,source:(map.getView().getCenter()),start:start}),ol.animation.bounce({duration:800,resolution:1.3*map.getView().getResolution(),start:start}));map.getView().fit([-13385849.855545742,4164163.9360093023,-12120670.513975333,5733155.322681262],(map.getSize()),{padding:[5,5,5,5],constrainResolution:false});}});}var layerSwitcher=new ol.control.LayerSwitcher();map.addControl(layerSwitcher);var viewExtent=[0,0,570,320.625];var viewProjection=new ol.proj.Projection({code:'ALERT(Tahoe)',units:'pixels',extent:viewExtent,});var imageMap=new ol.layer.Image({});var currentCam;function hide(){if(camBox!==undefined){nvcams.setTarget();maps.removeChild(camBox);camBox=undefined;map.getView().setRotation(0);}selectClick.getFeatures().clear();}var nvcams=new ol.Map({layers:[imageMap],controls:ol.control.defaults().extend([]),view:new ol.View({projection:viewProjection,extent:viewExtent,center:ol.extent.getCenter(viewExtent),zoom:1.15,minZoom:1.15,maxZoom:5}),logo:({href:'http://alerttahoe.seismo.unr.edu/firecams.html',src:'firecesium/examples/data/BLM UNR.jpg'})});function startMjpgTimeLapse(length){var id=currentCam.get('id');var imgUrl='http://myers.seismo.unr.edu/firecams/proxy/test/timelapse?hour='+length+'&id='+id;var imageSource=new ol.source.ImageStatic({attributions:'© <a href="http://alerttahoe.seismo.unr.edu/firecams.html">ALERT(Tahoe)</a>',url:imgUrl,projection:viewProjection,imageExtent:viewExtent});imageMap.setSource(imageSource);imageMap.on('postcompose',function(){nvcams.render();});}function stopTimeLapse(e){var stamp=(new Date).getTime();var imgUrl="http://myers.seismo.unr.edu:8095/vulcan/v0/camera/"+currentCam.getProperties()['id']+"/image?lastmodified="+stamp;var imageSource=new ol.source.ImageStatic({attributions:'© <a href="http://alerttahoe.seismo.unr.edu/firecams.html">ALERT(Tahoe)</a>',url:imgUrl,projection:viewProjection,imageExtent:viewExtent});imageMap.setSource(imageSource);imageMap.on('postcompose',function(){nvcams.render();});}function loadSources(){var rxSource=new ol.source.Vector({format:new ol.format.GeoJSON(),url:'https://gbcc.us/rxfires.geojson'});var newFiresSource=new ol.source.Vector({format:new ol.format.GeoJSON(),url:'https://gbcc.us/newfires.geojson'});var ongoingSource=new ol.source.Vector({format:new ol.format.GeoJSON(),url:'https://gbcc.us/ongoingfires.geojson'});var teamSource=new ol.source.Vector({format:new ol.format.GeoJSON(),url:"https://irwin.doi.gov/arcgis/rest/services/Irwin/FeatureServer/0/query?f=geojson"+"&where=UniqueFireIdentifier = '2016-IDBOF-000539'"+"&returnGeometry=true&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100"+"&token="+irwin});rxFiresLayer.setSource(rxSource);newFiresLayer.setSource(newFiresSource);ongoingFiresLayer.setSource(ongoingSource);teamFiresLayer.setSource(teamSource);ajax({method:'POST',url:'https://egp.nwcg.gov/arcgis/tokens/',params:{f:'json',username:EGP1,password:EGP2,client:'referer',referer:'https://gacc.nifc.gov/gbcc/',expiration:'1440'},headers:{'Content-Type':'application/x-www-form-urlencoded'}}).then(function(secondValue){egp=JSON.parse(secondValue).token;var egp6=new ol.source.Cluster({distance:2,source:new ol.source.Vector({format:new ol.format.EsriJSON(),url:'https://egp.nwcg.gov/arcgis/rest/services/FireCOP/FireDetections/MapServer/0/query?f=json'+'&where=AgeInHours < 6&returnGeometry=true&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100'+'&token='+egp})});var egp12=new ol.source.Cluster({distance:2,source:new ol.source.Vector({format:new ol.format.EsriJSON(),url:'https://egp.nwcg.gov/arcgis/rest/services/FireCOP/FireDetections/MapServer/0/query?f=json'+'&where=AgeInHours < 12&returnGeometry=true&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100'+'&token='+egp})});var egp24=new ol.source.Cluster({distance:2,source:new ol.source.Vector({format:new ol.format.EsriJSON(),url:'https://egp.nwcg.gov/arcgis/rest/services/FireCOP/FireDetections/MapServer/0/query?f=json'+'&where=AgeInHours < 24&returnGeometry=true&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100'+'&token='+egp})});var egp48=new ol.source.Cluster({distance:2,source:new ol.source.Vector({format:new ol.format.EsriJSON(),url:'https://egp.nwcg.gov/arcgis/rest/services/FireCOP/FireDetections/MapServer/0/query?f=json'+'&where=AgeInHours < 48&returnGeometry=true&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100'+'&token='+egp})});var egp999=new ol.source.Cluster({distance:2,source:new ol.source.Vector({format:new ol.format.EsriJSON(),url:'https://egp.nwcg.gov/arcgis/rest/services/FireCOP/FireDetections/MapServer/0/query?f=json'+'&where=AgeInHours < 50&returnGeometry=true&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100'+'&token='+egp})});var igpoint6=new ol.source.Cluster({distance:2,source:new ol.source.Vector({format:new ol.format.EsriJSON(),url:'https://egp.nwcg.gov/arcgis/rest/services/FireCOP/FireDetections/MapServer/4/query?f=json'+'&where=AgeInHours < 6&returnGeometry=true&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100'+'&token='+egp})});var igpoint12=new ol.source.Cluster({distance:2,source:new ol.source.Vector({format:new ol.format.EsriJSON(),url:'https://egp.nwcg.gov/arcgis/rest/services/FireCOP/FireDetections/MapServer/4/query?f=json'+'&where=AgeInHours < 12&returnGeometry=true&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100'+'&token='+egp})});var igpoint24=new ol.source.Cluster({distance:2,source:new ol.source.Vector({format:new ol.format.EsriJSON(),url:'https://egp.nwcg.gov/arcgis/rest/services/FireCOP/FireDetections/MapServer/4/query?f=json'+'&where=AgeInHours < 24&returnGeometry=true&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100'+'&token='+egp})});var igpoint48=new ol.source.Cluster({distance:2,source:new ol.source.Vector({format:new ol.format.EsriJSON(),url:'https://egp.nwcg.gov/arcgis/rest/services/FireCOP/FireDetections/MapServer/4/query?f=json'+'&where=AgeInHours < 48&returnGeometry=true&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100'+'&token='+egp})});var viirs6=new ol.source.Cluster({distance:2,source:new ol.source.Vector({format:new ol.format.EsriJSON(),url:'https://egp.nwcg.gov/arcgis/rest/services/FireCOP/FireDetections/MapServer/2/query?f=json'+'&where=AgeInHours < 6&returnGeometry=true&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100'+'&token='+egp})});var viirs12=new ol.source.Cluster({distance:2,source:new ol.source.Vector({format:new ol.format.EsriJSON(),url:'https://egp.nwcg.gov/arcgis/rest/services/FireCOP/FireDetections/MapServer/2/query?f=json'+'&where=AgeInHours < 12&returnGeometry=true&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100'+'&token='+egp})});var viirs24=new ol.source.Cluster({distance:2,source:new ol.source.Vector({format:new ol.format.EsriJSON(),url:'https://egp.nwcg.gov/arcgis/rest/services/FireCOP/FireDetections/MapServer/2/query?f=json'+'&where=AgeInHours < 24&returnGeometry=true&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100'+'&token='+egp})});var viirs48=new ol.source.Cluster({distance:2,source:new ol.source.Vector({format:new ol.format.EsriJSON(),url:'https://egp.nwcg.gov/arcgis/rest/services/FireCOP/FireDetections/MapServer/2/query?f=json'+'&where=AgeInHours < 48&returnGeometry=true&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100'+'&token='+egp})});egpModisFireDetectionCentroidLayer6.setSource(egp6);egpModisFireDetectionCentroidLayer12.setSource(egp12);egpModisFireDetectionCentroidLayer24.setSource(egp24);egpModisFireDetectionCentroidLayer48.setSource(egp48);igpointCentroidLayer6.setSource(igpoint6);igpointCentroidLayer12.setSource(igpoint12);igpointCentroidLayer24.setSource(igpoint24);igpointCentroidLayer48.setSource(igpoint48);viirsCentroidLayer6.setSource(viirs6);viirsCentroidLayer12.setSource(viirs12);viirsCentroidLayer24.setSource(viirs24);viirsCentroidLayer48.setSource(viirs48);}).then(function(){var nfs=newFiresLayer.getSource();var ofs=ongoingFiresLayer.getSource();var rxfs=rxFiresLayer.getSource();var countFeatures=function(layerSource,k,info){layerSource.once('change',function(e){if(layerSource.getState()==='ready'){legend[k].innerHTML=layerSource.getFeatures().length+' '+info;}});}
function firepop(ids,layerSource){layerSource.once('change',function(e){if(layerSource.getState()==='ready'){for(i=0;i<layerSource.getFeatures().length;i++){var key=layerSource.getFeatures()[i].getProperties().IncidentName;var value={};ids[key]=value;}}});}firepop(nfids,nfs);firepop(ofids,ofs);firepop(rxfids,rxfs);function extend(obj,src){for(var key in src){if(src.hasOwnProperty(key))obj[key]=src[key];}return obj;}var inc=extend(nfids,ofids);incidents=extend(inc,rxfids);countFeatures(nfs,0,'New Fires<tspan x="0" y="55">Initial Attack</tspan><tspan x="0" y="70">Age < 30 hrs</tspan>');countFeatures(ofs,1,'Ongoing Fires<tspan x="115" y="55">Age < 10 days &amp;</tspan><tspan x="115" y="70">Updated < 5 days</tspan>');return ajax({method:'POST',url:"https://egp.nwcg.gov/arcgis/rest/services/FireCOP/ActiveResources/MapServer/0/query?f=json&where=IncidentGacc = 'Great Basin Coordination Center'&returnGeometry=false&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100&token="+egp,headers:{'Content-Type':'application/x-www-form-urlencoded'}});}).then(function(zero){airtanker=JSON.parse(zero).features;resItems[0]=resSort(airtanker);return ajax({method:'POST',url:"https://egp.nwcg.gov/arcgis/rest/services/FireCOP/ActiveResources/MapServer/1/query?f=json&where=IncidentGacc = 'Great Basin Coordination Center'&returnGeometry=false&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100&token="+egp,headers:{'Content-Type':'application/x-www-form-urlencoded'}});}).then(function(one){dozer=JSON.parse(one).features;resItems[1]=resSort(dozer);return ajax({method:'POST',url:"https://egp.nwcg.gov/arcgis/rest/services/FireCOP/ActiveResources/MapServer/2/query?f=json&where=IncidentGacc = 'Great Basin Coordination Center'&returnGeometry=false&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100&token="+egp,headers:{'Content-Type':'application/x-www-form-urlencoded'}});}).then(function(two){engine=JSON.parse(two).features;resItems[2]=resSort(engine);return ajax({method:'POST',url:"https://egp.nwcg.gov/arcgis/rest/services/FireCOP/ActiveResources/MapServer/3/query?f=json&where=IncidentGacc = 'Great Basin Coordination Center'&returnGeometry=false&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100&token="+egp,headers:{'Content-Type':'application/x-www-form-urlencoded'}});}).then(function(three){crews=JSON.parse(three).features;resItems[3]=resSort(crews);return ajax({method:'POST',url:"https://egp.nwcg.gov/arcgis/rest/services/FireCOP/ActiveResources/MapServer/4/query?f=json&where=IncidentGacc = 'Great Basin Coordination Center'&returnGeometry=false&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100&token="+egp,headers:{'Content-Type':'application/x-www-form-urlencoded'}});}).then(function(four){fixedWing=JSON.parse(four).features;resItems[4]=resSort(fixedWing);return ajax({method:'POST',url:"https://egp.nwcg.gov/arcgis/rest/services/FireCOP/ActiveResources/MapServer/5/query?f=json&where=IncidentGacc = 'Great Basin Coordination Center'&returnGeometry=false&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100&token="+egp,headers:{'Content-Type':'application/x-www-form-urlencoded'}});}).then(function(five){IMTs=JSON.parse(five).features;resItems[5]=resSort(IMTs);return ajax({method:'POST',url:"https://egp.nwcg.gov/arcgis/rest/services/FireCOP/ActiveResources/MapServer/6/query?f=json&where=IncidentGacc = 'Great Basin Coordination Center'&returnGeometry=false&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100&token="+egp,headers:{'Content-Type':'application/x-www-form-urlencoded'}});}).then(function(six){helicopter=JSON.parse(six).features;resItems[6]=resSort(helicopter);}).catch(function(error){console.error('damnit.',error.statusText);});refresh.innerHTML=new Date(Date.now()).toLocaleString().split(', ')[1];}loadSources();setInterval(loadSources,900000);