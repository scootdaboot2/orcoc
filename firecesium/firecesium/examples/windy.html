<!doctype html>
<html lang="en">
  <head>
    <title>windy.js integration example</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <link rel="stylesheet" href="../ol3-7/ol.css" type="text/css">
    <style type="text/css">
    #map {
      width: 100%;
      height: 100%;
      position: relative;
    }
    div.fill {
      width: 100%;
      height: 100%;
    }
    #windyMap {
      position: absolute;
      z-index: 1;
      pointer-events: none;
    }
    .ol-control {
      z-index: 2;
    }
    </style>
  </head>
  <body>
    <div id="map" class="map">
      <canvas id="windyMap" class="fill"></canvas>
      <div id="olMap" class="fill"></div>
    </div>
    <script src="../ol3-7/ol.js" type="text/javascript"></script>
    <script src="https://esri.github.io/wind-js/windy.js" type="text/javascript"></script>
  <script type="text/javascript">
    var mapboxToken = 'pk.eyJ1IjoicnRpcHBldHRzIiwiYSI6ImNpb2huaWtuNDAwNnF1NW0xNWFhYXJiM20ifQ.-c3uBsqfQoJgd3gG4TbNLw#0/0/0/0';

    var mapbox = new ol.layer.Tile({
      source: new ol.source.XYZ({
        attributions: '© <a href="https://www.mapbox.com/map-feedback/">Mapbox</a> ' +
                      '© <a href="http://www.openstreetmap.org/copyright">' +
                      'OpenStreetMap contributors</a>',
        crossOrigin: 'anonymous',
        // tileSize: [512, 512],
        // url: 'https://api.mapbox.com/styles/v1/mapbox/outdoors-v9/tiles/{z}/{x}/{y}?access_token=' + mapboxToken
        url: 'https://api.tiles.mapbox.com/v4/mapbox.dark/{z}/{x}/{y}.png?access_token=' + mapboxToken
      }),
      wrapX: false
    });

    var clipStyle = new ol.style.Style({
      fill: new ol.style.Fill({
        color: 'black'
      })
    });
    var clipLayer = new ol.layer.Image({
      source: new ol.source.ImageVector({
        source: new ol.source.Vector({
          url: 'data/topojson/gbccBoundaries.topojson',
          format: new ol.format.TopoJSON()
        }),
        style: clipStyle 
      })
    });
    clipLayer.on('postcompose', function(e) {
      e.context.globalCompositeOperation = 'source-over';
    });
    clipLayer.on('precompose', function(e) {
      e.context.globalCompositeOperation = 'destination-in';
    });

    var overallView = new ol.View({
      // center: ol.proj.transform([-114.012036, 40.440194], 'EPSG:4326','EPSG:3857'),
      center: [-12753260.184760537, 4948659.629345282],
      zoom: 5.55,
      minZoom: 5,
      maxZoom: 15,
      // extent:[ -13385849.855545742, 4164163.9360093023, -12120670.513975333, 5733155.322681262 ]
    });
    var map = new ol.Map({
      layers: [
        mapbox,
        clipLayer
        // new ol.layer.Tile({
        //   source: new ol.source.Stamen({
        //     layer: 'terrain'
        //   })
        // })
      ],
      interactions: ol.interaction.defaults({
        altShiftDragRotate: false,
        rotate: false
      }),
      target: 'olMap',
      view: overallView
      // view: new ol.View({
      //   center: [0, 0],
      //   zoom: 1
      // })
    });

    var windy;
    var canvas = document.getElementById('windyMap');
    function refreshWindy() {
      if(!windy) {
        return;
      }
      windy.stop();
      var mapSize = map.getSize();
      var extent = map.getView().calculateExtent(mapSize);
      extent = ol.proj.transformExtent(extent, 'EPSG:3857', 'EPSG:4326');

      canvas.width = mapSize[0];
      canvas.height = mapSize[1];

      windy.start(
        [[0,0], [canvas.width, canvas.height]],
        canvas.width,
        canvas.height,
        [[extent[0], extent[1]],[extent[2], extent[3]]]
      );
    }

    fetch('https://esri.github.io/wind-js/gfs.json').then(function(response) {
      return response.json();
    }).then(function(json) {
      windy = new Windy({canvas: canvas, data: json });
      refreshWindy();
    });

    map.on('moveend', refreshWindy);
  </script>
  </body>
</html>