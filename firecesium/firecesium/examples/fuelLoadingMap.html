<DOCTYPE! html>
<html lang="en">
<head>
<title>EPSG:3857 GEOJSON</title>
<link rel="stylesheet" href="http://openlayers.org/en/v3.16.0/css/ol.css" type="text/css">
<style type="text/css">
.map {
  height: 400px;
  width: 600px;
}
</style>
</head>
<body>
<div id="map" class="map"></div>
<label>Geometry type &nbsp;</label>
  <select id="type">
    <option value="None">None</option>
    <option value="Point">Point</option>
    <option value="LineString" selected>LineString</option>
    <option value="Polygon">Polygon</option>
  </select>
<!-- <label>Data type &nbsp;</label>
<select id="data_type">
    <option value="GeoJSON" selected>GeoJSON</option>
    <option value="KML">KML</option>
    <option value="GPX">GPX</option>
</select> -->
<label>Zone &nbsp;</label>
  <select id="selectDispatch">
    <option value=""></option>
    <!-- <option value=""></option> -->
    <option value="" selected></option>
    <option value=""></option>
  </select>
<div id="delete" style="text-decoration:underline;cursor:pointer">Delete all features</div>
<div id='upload' style="text-decoration:underline;cursor:pointer">Upload to mongodb</div>
<label>Data: &nbsp;</label>
<textarea id="data" rows="10" style="width:100%"></textarea>
<!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script> -->
<script src="http://openlayers.org/en/v3.16.0/build/ol.js" type="text/javascript"></script>
<script type="text/javascript">

var mlabKey = 'PJfhY3w2U58ZczDkxR-dsqlo_9THZblN';

var options = {
  method: String,
  headers: Object, // automatically default to either 'application/x-www-form-urlencoded' or 'multipart/form-data')
  mode: String,
  cache: String
};

var dispatches;

// fetch('https://api.mlab.com/api/1/databases/fuelzonemaps/collections/zones?f={"features.properties.IFCNAME": 1}&apiKey=' + mlabKey, {mode: 'cors'})
// .then(
//   function (response) {
//     if (response.status !== 200) {
//       console.log('damnit. Status Code: ' + response.status);
//       return;
//     }
//     // Examine the text in the response
//     response.json().then(function (data) {
//       DATA = data;
//       console.log(DATA);
//     }); 
//   }
// )
// .catch(function (err) {
//   console.log('Fetch Error : ', err)
// });

var fetchResult;
fetch('https://api.mlab.com/api/1/databases/fuelzonemaps/collections/zones?f={"features.properties.IFCNAME": 1}&apiKey=' + mlabKey, {mode: 'cors'})
  .then(function (response) {
    return response.text();
  })
  .then(function(text) {
    fetchResult = text;
    data.innerHTML = fetchResult;
  })
  .catch(function (error) {
    console.log('damnit.', error)
  });

var overallView = new ol.View({
  // center: ol.proj.transform([-114.012036, 40.440194], 'EPSG:4326','EPSG:3857'),
  center: [-12753260.184760537, 4948659.629345282],
  zoom: 5.55,
  minZoom: 5,
  maxZoom: 15,
  extent:[ -13385849.855545742, 4164163.9360093023, -12120670.513975333, 5733155.322681262 ]
});


var dispatchBoundaries = new ol.layer.Vector({
  // source: new ol.source.Vector({
  //   features: (new ol.format.TopoJSON()).readFeatures(gbccBoundaries)
  // }),
  source: new ol.source.Vector({
    // url: 'data/topojson/egpGbccLocal.topojson',
    // url: 'data/topojson/gbccBoundaries.topojson',
    url: 'data/topojson/gbccLocalWebsites.topojson',
    format: new ol.format.TopoJSON()
    // url: 'data/geojson/gbccLocalWebsites.geojson',
    // format: new ol.format.GeoJSON()
    }),
  wrapX: false,
  // minResolution: 0,
  // maxResolution: 5000,
  visible: true,
  style: new ol.style.Style({
    // fill: new ol.style.Fill({
    //   color: 'rgba(255, 255, 255, 0.1)'
    // }),
    stroke: new ol.style.Stroke({
      // color: 'rgba(128, 128, 0, 1)',
      color: '#683A5E',
      width: 2
    }),
    text: new ol.style.Text({
      font: '.9rem Montserrat, sans-serif',
      fill: new ol.style.Fill({
        color: '#000'
      })
      // ,
      // stroke: new ol.style.Stroke({
      //   color: '#fff',
      //   width: 3
      // })
    })
  })
});
// create a vector layer used for editing
var source = new ol.source.Vector();

var vector = new ol.layer.Vector({
  source: source,
  style: new ol.style.Style({
    fill: new ol.style.Fill({
      color: 'rgba(255, 255, 255, 0.2)'
    }),
    stroke: new ol.style.Stroke({
      color: '#ffcc33',
      width: 2
    }),
    image: new ol.style.Circle({
      radius: 7,
      fill: new ol.style.Fill({
        color: '#ffcc33'
      })
    })
  })
});

// Create a map
var map = new ol.Map({
  target: 'map',
  layers: [
    new ol.layer.Tile({
      source: new ol.source.OSM()
    }),
    dispatchBoundaries,
    vector
  ],
  view: overallView
});

// make draw global so it can later be removed
var draw;

// creat a select to choose geometry type
var typeSelect = document.getElementById('type');
// rebuild interaction when changed
typeSelect.onchange = function(e) {
  map.removeInteraction(draw);
  addInteraction();
};

// // create a select to choose a data type to save in
// dataTypeSelect = document.getElementById('data_type');
// // clear map and rebuild interaction when changed
// dataTypeSelect.onchange = function(e) {
//   clearMap();
//   map.removeInteraction(draw);
//   addInteraction();
// };
// add draw interaction
function addInteraction() {
  var geom_type = typeSelect.value;
  if (geom_type !== 'None') {
    draw = new ol.interaction.Draw({
      source: source,
      type: /** @type {ol.geom.GeometryType} */ (geom_type)
    });
    map.addInteraction(draw);
    var drawnFeatures = [];
    draw.on('drawend', function(event) {
      drawnFeatures.push(event.feature);
    })
    // draw.on('drawend', function(evt) {
    //   saveData();
    // });
    source.on('addfeature', function (event) {
      var index = drawnFeatures.indexOf(event.feature);
      if (index > -1) {
        // feature added to source from drawinteraction
        // do whatever
        drawnFeatures.splice(index, 1);
        displayData();
      }
    });
  }
}

function displayData() {
  var allFeatures = vector.getSource().getFeatures();
  var format = new ol.format.GeoJSON();
  var data = format.writeFeatures(allFeatures, {featureProjection: 'EPSG:3857'});
  document.getElementById('data').value = data;
}

function saveData() {
  var allFeatures = vector.getSource().getFeatures();
  var format = new ol.format.GeoJSON();
  var data = format.writeFeatures(allFeatures, {featureProjection: 'EPSG:3857'});

  // Create an empty Headers instance
  var headers = new Headers();
  headers.append('Content-Type', 'application/json');

  fetch('https://api.mlab.com/api/1/databases/fuelzonemaps/collections/createdfeatures?&apiKey=' + mlabKey, {method: 'POST', headers, body: data})
    .then(
      function (response) {
        if (response.status !== 200) {
          console.log('damnit. Status Code: ' + response.status);
          return;
        }
        // Examine the text in the response
        response.json().then(function (data) {
          console.log(data);
        }); 
      }
    )
    .catch(function (err) {
      console.log('Fetch Error : ', err)
    });      
}
// add the interaction when the page is first shown
addInteraction();

// clears the map and the output of the data
function clearMap() {
  vector.getSource().clear();
  document.getElementById('data').value = '';
}
// clear map when user clicks on 'Delete all features'
var deleteFeatures = document.getElementById('delete');
deleteFeatures.addEventListener('click', function() {
  clearMap();
});

var uploadFeatures = document.getElementById('upload');
uploadFeatures.addEventListener('click', function() {
  saveData();
});


</script>
</body>
</html>